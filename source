local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local StarterGui = game:GetService("StarterGui")
local Debris = game:GetService("Debris")

local player = Players.LocalPlayer
local guiName = "GriefLoggerUI"

if player.PlayerGui:FindFirstChild(guiName) then
	player.PlayerGui[guiName]:Destroy()
end

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = guiName
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = player.PlayerGui

local MainFrame = Instance.new("Frame", ScreenGui)
MainFrame.Size = UDim2.fromScale(0.135, 0.392)
MainFrame.Position = UDim2.fromScale(0.005, 0.25)
MainFrame.BackgroundColor3 = Color3.fromRGB(38,38,38)
MainFrame.BorderSizePixel = 0
Instance.new("UICorner", MainFrame)

local stroke = Instance.new("UIStroke", MainFrame)
stroke.Thickness = 2.5
stroke.Color = Color3.fromRGB(91,216,7)

local TitleFrame = Instance.new("Frame", MainFrame)
TitleFrame.Size = UDim2.fromScale(0.792, 0.107)
TitleFrame.Position = UDim2.fromScale(0.092, 0.035)
TitleFrame.BackgroundColor3 = Color3.fromRGB(48,48,48)
TitleFrame.BorderSizePixel = 0
Instance.new("UICorner", TitleFrame)

local TitleLabel = Instance.new("TextLabel", TitleFrame)
TitleLabel.Size = UDim2.fromScale(1,1)
TitleLabel.BackgroundTransparency = 1
TitleLabel.Text = "GRIEF LOGS >:("
TitleLabel.TextColor3 = Color3.fromRGB(96,255,48)
TitleLabel.TextScaled = true
TitleLabel.FontFace = Font.new("rbxasset://fonts/families/GothamSSm.json", Enum.FontWeight.Bold)

local LogsFrame = Instance.new("ScrollingFrame", MainFrame)
LogsFrame.Size = UDim2.fromScale(0.8, 0.46)
LogsFrame.Position = UDim2.fromScale(0.085, 0.18)
LogsFrame.ScrollBarImageTransparency = 1
LogsFrame.CanvasSize = UDim2.new()
LogsFrame.BackgroundColor3 = Color3.fromRGB(48,48,48)
LogsFrame.BorderSizePixel = 0
Instance.new("UICorner", LogsFrame)

local LogsLayout = Instance.new("UIListLayout", LogsFrame)
LogsLayout.Padding = UDim.new(0,2)
LogsLayout.VerticalAlignment = Enum.VerticalAlignment.Top

LogsLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
	LogsFrame.CanvasSize = UDim2.new(0,0,0,LogsLayout.AbsoluteContentSize.Y)
end)

local UsernameFrame = Instance.new("Frame", MainFrame)
UsernameFrame.Size = UDim2.fromScale(0.8, 0.28)
UsernameFrame.Position = UDim2.fromScale(0.084, 0.68)
UsernameFrame.BackgroundColor3 = Color3.fromRGB(48,48,48)
UsernameFrame.BorderSizePixel = 0
Instance.new("UICorner", UsernameFrame)

local InputBox = Instance.new("TextBox", UsernameFrame)
InputBox.Size = UDim2.fromScale(0.9, 0.28)
InputBox.Position = UDim2.fromScale(0.05, 0.05)
InputBox.PlaceholderText = "Username or DisplayName"
InputBox.Text = ""
InputBox.BackgroundColor3 = Color3.fromRGB(54,54,54)
InputBox.TextColor3 = Color3.fromRGB(96,255,48)
InputBox.ClearTextOnFocus = false
InputBox.BorderSizePixel = 0
InputBox.FontFace = Font.new("rbxasset://fonts/families/GothamSSm.json", Enum.FontWeight.Bold)
Instance.new("UICorner", InputBox)

local PreviewLabel = Instance.new("TextLabel", UsernameFrame)
PreviewLabel.Size = UDim2.fromScale(0.9, 0.2)
PreviewLabel.Position = UDim2.fromScale(0.05, 0.38)
PreviewLabel.BackgroundTransparency = 1
PreviewLabel.TextColor3 = Color3.fromRGB(160,255,160)
PreviewLabel.TextSize = 10
PreviewLabel.FontFace = Font.new("rbxasset://fonts/families/GothamSSm.json", Enum.FontWeight.Medium)
PreviewLabel.Text = ""

local ListLabel = Instance.new("TextLabel", UsernameFrame)
ListLabel.Size = UDim2.fromScale(0.9, 0.3)
ListLabel.Position = UDim2.fromScale(0.05, 0.62)
ListLabel.BackgroundTransparency = 1
ListLabel.TextWrapped = true
ListLabel.TextSize = 10
ListLabel.TextColor3 = Color3.fromRGB(96,255,48)
ListLabel.FontFace = Font.new("rbxasset://fonts/families/GothamSSm.json", Enum.FontWeight.Bold)

local protected = {}
local watchers = {}
local logs = {}
local logCounts = {}
local stackLogs = false
local hidden = false

local function timestamp()
	return os.date("[%H:%M:%S]")
end

local function notify(txt)
	StarterGui:SetCore("SendNotification", {
		Title = "Grief Logger",
		Text = txt,
		Duration = 3
	})
end

local function refreshList()
	local t = {}
	for n in pairs(protected) do
		table.insert(t,n)
	end
	ListLabel.Text = table.concat(t,", ")
end

local function addLog(text, key)
	if stackLogs and key then
		logCounts[key] = (logCounts[key] or 0) + 1
		text = text.." (x"..logCounts[key]..")"
	end
	local label = Instance.new("TextLabel")
	label.Size = UDim2.new(1, -4, 0, 11)
	label.BackgroundTransparency = 1
	label.TextWrapped = true
	label.TextXAlignment = Enum.TextXAlignment.Left
	label.TextYAlignment = Enum.TextYAlignment.Top
	label.TextColor3 = Color3.fromRGB(200,255,200)
	label.TextSize = 8
	label.FontFace = Font.new("rbxasset://fonts/families/GothamSSm.json", Enum.FontWeight.Bold)
	label.Text = text
	label.Parent = LogsFrame
	table.insert(logs, 1, label)
	label.LayoutOrder = 0
	for i = 2, #logs do
		logs[i].LayoutOrder = i
	end
	if #logs > 30 then
		logs[#logs]:Destroy()
		table.remove(logs, #logs)
	end
end

local function watchUser(username)
	if watchers[username] then return end
	local folder = workspace.Bricks:FindFirstChild(username)
	if not folder then return end
	watchers[username] = folder.ChildRemoved:Connect(function(brick)
		if brick.Name ~= "Brick" then return end
		addLog(timestamp().." "..username.." brick deleted","del_"..username)
		for _,plr in Players:GetPlayers() do
			if plr.Name ~= username and not protected[plr.Name] and plr.Character then
				local tool = plr.Character:FindFirstChildOfClass("Tool")
				if tool then
					if tool.Name:find("Delete") or (tool:FindFirstChild("Handle") and tool.Handle.Color == Color3.fromRGB(196,40,28)) then
						addLog(timestamp().." "..plr.Name.." holding Delete","tool_"..plr.Name)
					end
				end
			end
		end
	end)
end

InputBox:GetPropertyChangedSignal("Text"):Connect(function()
	local txt = InputBox.Text:lower()
	PreviewLabel.Text = ""
	if txt == "" then return end
	for _,plr in Players:GetPlayers() do
		if plr.Name:lower():find(txt,1,true) or plr.DisplayName:lower():find(txt,1,true) then
			PreviewLabel.Text = plr.DisplayName.." ("..plr.Name..")"
			return
		end
	end
end)

InputBox.FocusLost:Connect(function(enter)
	if not enter then return end
	local txt = InputBox.Text:lower()
	InputBox.Text = ""
	local selectedName = nil
	for _, plr in ipairs(Players:GetPlayers()) do
		if plr.Name:lower() == txt or plr.DisplayName:lower() == txt then
			selectedName = plr.Name
			break
		end
	end
	if not selectedName and PreviewLabel.Text ~= "" then
		local nameInParens = PreviewLabel.Text:match("%((.-)%)")
		if nameInParens then
			selectedName = nameInParens
		end
	end
	if selectedName then
		local plr = Players:FindFirstChild(selectedName)
		if plr then
			if protected[plr.Name] then
				protected[plr.Name] = nil
				if watchers[plr.Name] then watchers[plr.Name]:Disconnect() end
				watchers[plr.Name] = nil
				notify("Removed "..plr.Name)
			else
				protected[plr.Name] = true
				watchUser(plr.Name)
				notify("Protected "..plr.Name)
			end
			refreshList()
		end
	end
	PreviewLabel.Text = ""
end)

Players.PlayerRemoving:Connect(function(plr)
	if protected[plr.Name] then
		protected[plr.Name] = nil
		if watchers[plr.Name] then watchers[plr.Name]:Disconnect() end
		watchers[plr.Name] = nil
		notify("Removed "..plr.Name.." (left the server)")
		refreshList()
	end
end)

UserInputService.InputBegan:Connect(function(input,gp)
	if gp then return end
	if input.KeyCode == Enum.KeyCode.Zero then
		hidden = not hidden
		local x = hidden and -0.2 or 0.005
		TweenService:Create(MainFrame,TweenInfo.new(0.35),{Position = UDim2.fromScale(x, MainFrame.Position.Y.Scale)}):Play()
	elseif input.KeyCode == Enum.KeyCode.Eight then
		stackLogs = not stackLogs
		notify("Log stacking: "..(stackLogs and "ON" or "OFF"))
	end
end)

local mouse = player:GetMouse()
local clickCounts = {}
local lastClickTime = {}
local CLICK_RESET_TIME = 1.2
local REQUIRED_CLICKS = 3

local function highlightUserBricks(username)
	local folder = workspace:FindFirstChild("Bricks")
	if not folder then return end
	local userFolder = folder:FindFirstChild(username)
	if not userFolder then return end
	for _, brick in ipairs(userFolder:GetChildren()) do
		if brick:IsA("BasePart") then
			local hl = Instance.new("Highlight")
			hl.FillColor = Color3.fromRGB(255, 200, 60)
			hl.OutlineColor = Color3.fromRGB(255, 255, 255)
			hl.FillTransparency = 0.4
			hl.OutlineTransparency = 0
			hl.Parent = brick
			Debris:AddItem(hl, 3)
		end
	end
end

mouse.Button1Down:Connect(function()
	local target = mouse.Target
	if not target or not target:IsA("BasePart") then return end
	local ownerFolder = target.Parent
	while ownerFolder and ownerFolder.Parent ~= workspace:FindFirstChild("Bricks") do
		ownerFolder = ownerFolder.Parent
	end
	if not ownerFolder or ownerFolder.Parent ~= workspace:FindFirstChild("Bricks") then return end
	local ownerName = ownerFolder.Name
	local ownerPlayer = Players:FindFirstChild(ownerName)
	local displayName = ownerPlayer and ownerPlayer.DisplayName or ownerName
	local leftText = ownerPlayer and "" or " (left)"

	local now = tick()
	if lastClickTime[target] and now - lastClickTime[target] > CLICK_RESET_TIME then
		clickCounts[target] = 0
	end
	lastClickTime[target] = now
	clickCounts[target] = (clickCounts[target] or 0) + 1

	if clickCounts[target] >= REQUIRED_CLICKS then
		clickCounts[target] = 0
		notify("Block owner: "..displayName.." ("..ownerName..")"..leftText)
		highlightUserBricks(ownerName)
	end
end)

